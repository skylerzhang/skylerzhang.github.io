<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>苍蝇爱屎蛋</title>
    <style>
        body {
            text-align: center;
        }
        #turd {
            margin-top: 10px;
            border: solid 1px black;
        }
    </style>
    <script src="common.js"></script>
    <script src="resources.js"></script>
    <script src="flying.js"></script>
    <script src="flying_dead.js"></script>
    <script src="turd_default.js"></script>
    <script>

        document.addEventListener('DOMContentLoaded', function(){
            var oC = document.getElementById('turd');
            var gd = oC.getContext('2d');
            var W = oC.width, H = oC.height;
            var num = 0;
            var aFlying = [];
            var aDeadFlying = [];
            var aFiredFlying =[];
            var bFire = false;
            var durFire = false;

            loadImages(imgArr,function(imgs){

                oC.addEventListener('click', function(ev){
                    aFiredFlying.length = 0;
                    var disTurd = distance(ev, oC, turd);
                    var disTurdLookAround = distance(ev, oC, turdLookAround);

                    if (disTurd <= turd.w/2 || disTurdLookAround <= turdLookAround.w/2){

                        bFire = true;
                        turdFire.nowFrame = 0;
                        setTimeout(function(){
                            //bFire = false;
//                            for(var i =0 ; i<aFlying.length; i++){
//                                aFlying[i].img = imgs.flying_fired;
//                                aFlying[i].maxFrame = 16;
//                                aFlying[i].rotate = 0;
//                            }
                            durFire = true;


                        }, 2700);

                        setTimeout(function(){
                            bFire = false;
                            durFire = false;
                            aFlying.length = 0;
                            aFiredFlying.length = 0;
                            //aFlying.length = 0;
                        }, 1600+2700);


                    }

                    for (var i=0; i<aFlying.length; i++){

                        var dis = distance(ev, oC, aFlying[i]);

                        if(dis<=aFlying[i].w/2){
                            var deadFlying = new DeadFlying(aFlying[i].img, aFlying[i].w, aFlying[i].h, 3);
                            deadFlying.x = aFlying[i].x;
                            deadFlying.y = aFlying[i].y;
                            deadFlying.rotate = aFlying[i].rotate;

                            aDeadFlying.push(deadFlying);

                            (function(deadFlying){
                                setTimeout(function(){
                                    for (var i = 0; i < aDeadFlying.length; i++) {
                                        if (aDeadFlying[i] == deadFlying){
                                            aDeadFlying.splice(i, 1);
                                            break;
                                        }
                                    }
                                }, 500);
                            })(deadFlying);

                            aFlying.splice(i--, 1);

                        }

                        //释放技能
                        var firedFlying = new FiredFlying(imgs.flying_fired, 100, 100, 16);
                        firedFlying.x = aFlying[i].x;
                        firedFlying.y = aFlying[i].y;
                        aFiredFlying.push(firedFlying);

                    }

                }, false);

                var flyings = [
                    {img:imgs.flying, w:50, h:50},
                    {img:imgs.bigFlying, w:100, h:100}
                ];

                var turd = new TurdDefault(imgs.turd_default, 100, 100, 4);
                turd.x = W/2;
                turd.y = H/2;

                var turdLookAround =  new TurdLookAround(imgs.turd_lookaround, 100, 100, 8);
                turdLookAround.x = W/2;
                turdLookAround.y = H/2;

                var turdFire = new TurdFire(imgs.turd_fire2, 600, 600, 27);
                turdFire.x = W/2;
                turdFire.y = H/2;


                function nextFlyings(){
                    setTimeout(function(){
                        var flying = flyings[Math.floor(Math.random()*flyings.length)];
                        var oF = new Flying(flying.img, flying.w, flying.h, 4);

                        oF.x = Math.random() * W;
                        if (Math.random() < 0.5 ) {
                            oF.y = H + 100;
                            oF.rotate = Math.random() * 90 - 45;
                        } else {

                            oF.y = -100;
                            oF.rotate = Math.random() * 90 + 135;
                        }
                        aFlying.push(oF);

                        nextFlyings();

                    }, Math.random()*500);
                }

                nextFlyings();

                //绘制
                setInterval(function(){
                    num ++;
                    gd.clearRect(0, 0, W, H);


                    //画死苍蝇
                    for (var i = 0; i<aDeadFlying.length; i++){
                        aDeadFlying[i].draw(gd);
                    }

                    if(bFire){
                        //屎蛋火焰技能
                        turdFire.draw(gd);
                        if(durFire){
                            //画烧死的苍蝇
                            for (var i = 0; i < aFiredFlying.length; i++){
                                aFiredFlying[i].draw(gd);
                            }
                        }else {
                            //不动的苍蝇
                            for (var i = 0; i < aFlying.length; i++){
                                if (outOfScreen(aFlying[i], W, H, 100)){
                                    aFlying.splice(i--, 1);
                                    continue;
                                }
                                aFlying[i].draw(gd);
                            }
                        }


                    } else {
                        //画苍蝇

                        for (var i = 0; i < aFlying.length; i++){
                            if (outOfScreen(aFlying[i], W, H, 100)){
                                aFlying.splice(i--, 1);
                                continue;
                            }
//                        if(!bFire){
//                            aFlying[i].move();
//                        }
                            aFlying[i].move();
                            aFlying[i].draw(gd);
                        }
                        //画屎蛋
                        if(num%200>50){
                            turd.draw(gd);
                        } else {
                            turdLookAround.draw(gd);
                        }
                    }

                }, 16);

                //帧频动画
                setInterval(function(){
                    for (var i = 0; i < aFlying.length; i++){
                        aFlying[i].nextFrame();
                    }

                    for (var i = 0; i < aFiredFlying.length; i++){
                        aFiredFlying[i].nextFrame();
                    }

                    for (var i = 0; i < aDeadFlying.length; i++){
                        aDeadFlying[i].nextFrame();
                    }

                    if(bFire){
                        //火焰技能
                        turdFire.nextFrame();
                    } else {
                        //屎蛋左顾右盼
                        turdLookAround.nextFrame();
                    }

                },100);

                //屎蛋眨眼
                setInterval(function(){
                    turd.nextFrame();
                },200)
                

            })
        }, function(){
            alert('加载失败');
        } ,false)
    </script>
</head>
<body>
<canvas id="turd" width="800" height="600">

</canvas>
</body>
</html>